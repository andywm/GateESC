/*------------------------------------------------------------------------------
 ()		File: framework.cpp
 /\		Authour: Andrew Woodward-May
/  \	Date: March 2022	License: MIT

Description:
	Base Framework
------------------------------------------------------------------------------*/

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#include <Arduino.h>
#include "framework.h"
#include "motor/motor_controller.h"
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
MotorController MotorControl;

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
// Framework
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
Framework::Timings Framework::Timing;

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
void Framework::Run()
{
	Init();

	while(true)
	{
		TickTimers();
	}
}

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
void Framework::Init()
{

}

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
void Framework::TickTimers()
{
	Timing.this_timestamp = micros();
	if( Timing.this_timestamp - Timing.last_timestamp > 0 )
	{
		Timing.since = Timing.this_timestamp - Timing.last_timestamp;
	}
	else if ( Timing.this_timestamp - Timing.last_timestamp > INT64_MAX )
	{
		Timing.since = UINT64_MAX - Timing.last_timestamp + Timing.this_timestamp;
	}
	Timing.last_timestamp = Timing.this_timestamp;	
}

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
void Framework::Tick()
{
	//MotorControl.Update();
}

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
void Framework::Assert(bool bCondition, const char* Msg/*=nullptr*/)
{
	if( bCondition == false )
	{
		//todo, serial write message if available.
		Halt();
	}
}

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
void Framework::Assert0(bool bCondition, const char* Msg/*=nullptr*/)
{
	if( bCondition == true )
	{
		//todo, serial write message if available.
		Halt();
	}
}

//-------------------------------------------------------------------------------
//-------------------------------------------------------------------------------
void Framework::Halt()
{
	//todo, write all registers to zero.
	abort();
}
